{
  "agent_name": "presale_scenarios_runner_agent",
  "version": "2.1.1",
  "mode": "create",
  "language": "id",
  "goal": "Buat 3 presale di BSC testnet via PresaleFactory dan jalankan skenario test on-chain untuk memverifikasi alur hardcap success, softcap-only success, dan fail+refund. Gunakan native BNB, softcap 2.5 BNB, hardcap 5 BNB, max per wallet 1 BNB. Sertakan script create + contribute + finalize + verify fee split + refund verification.",
  "inputs": {
    "network": {
      "name": "bscTestnet",
      "chainId": 97,
      "rpc_env": "BSC_TESTNET_RPC_URL"
    },
    "contracts": {
      "feeSplitter": "0xce329E6d7415999160bB6f47133b552a91C915a0",
      "factory": "0x237cc0f76e64DA3172bb7705287617f03DC0B016"
    },
    "config": {
      "timelock": "0xdce552fa663879e2453f2259ced9f06a0c4a6a2d",
      "treasuryVault": "0xf87d43d64dab56c481483364ea46b0432a495805",
      "referralPoolVault": "0x3e78cac12633b223e23d7d3db120a87968245842",
      "sbtStakingVault": "0x7176e724e4d83d0a85e9af49c412ea2a24a22625",
      "feeBps": { "total": 500, "treasury": 250, "referral": 200, "sbt": 50 }
    },
    "env_requirements": {
      "admin_pk_env": "ADMIN_PRIVATE_KEY",
      "timelock_pk_env": "TIMELOCK_PRIVATE_KEY",
      "buyers_pk_envs": [
        "BUYER1_PRIVATE_KEY",
        "BUYER2_PRIVATE_KEY",
        "BUYER3_PRIVATE_KEY",
        "BUYER4_PRIVATE_KEY",
        "BUYER5_PRIVATE_KEY",
        "BUYER6_PRIVATE_KEY"
      ],
      "note": "Buyer wallets masing-masing saldo ~4.9 BNB. Jangan print PK ke output/log."
    },
    "presale_common_params": {
      "softCapBNB": "2.5",
      "hardCapBNB": "5.0",
      "maxPerWalletBNB": "1.0",
      "minContributionBNB": "0.1",
      "paymentToken": "NATIVE_BNB",
      "lpPlan": {
        "lockMonths": 12,
        "dexId": "PANCAKESWAP",
        "liquidityPercent": 7000
      },
      "vesting": {
        "tgeUnlockBps": 1000,
        "cliffSeconds": 0,
        "vestingSeconds": 2592000,
        "scheduleSalt": "AUTO"
      }
    }
  },
  "scenarios": [
    {
      "id": "S1_HARDCAP_SUCCESS",
      "name": "Presale hardcap tercapai (5 BNB) + finalizeSuccess + cek fee split",
      "contributions": [
        {
          "buyer": "BUYER1_PRIVATE_KEY",
          "amountBNB": "1.0",
          "referrer": "0x0000000000000000000000000000000000000000"
        },
        { "buyer": "BUYER2_PRIVATE_KEY", "amountBNB": "1.0", "referrer": "BUYER1" },
        { "buyer": "BUYER3_PRIVATE_KEY", "amountBNB": "1.0", "referrer": "BUYER1" },
        { "buyer": "BUYER4_PRIVATE_KEY", "amountBNB": "1.0", "referrer": "BUYER1" },
        { "buyer": "BUYER5_PRIVATE_KEY", "amountBNB": "1.0", "referrer": "BUYER1" }
      ],
      "expected": {
        "totalRaisedBNB": "5.0",
        "finalize": "SUCCESS",
        "feeTotalBNB": "0.25",
        "feeSplitBNB": {
          "treasury": "0.125",
          "referral": "0.10",
          "sbt": "0.025"
        }
      }
    },
    {
      "id": "S2_SOFTCAP_ONLY_SUCCESS",
      "name": "Presale hanya capai softcap (3 BNB) + finalizeSuccess",
      "contributions": [
        {
          "buyer": "BUYER1_PRIVATE_KEY",
          "amountBNB": "1.0",
          "referrer": "0x0000000000000000000000000000000000000000"
        },
        { "buyer": "BUYER2_PRIVATE_KEY", "amountBNB": "1.0", "referrer": "BUYER1" },
        { "buyer": "BUYER3_PRIVATE_KEY", "amountBNB": "1.0", "referrer": "BUYER1" }
      ],
      "expected": {
        "totalRaisedBNB": "3.0",
        "finalize": "SUCCESS",
        "feeTotalBNB": "0.15",
        "feeSplitBNB": {
          "treasury": "0.075",
          "referral": "0.06",
          "sbt": "0.015"
        }
      }
    },
    {
      "id": "S3_FAIL_REFUND",
      "name": "Presale tidak capai softcap (2 BNB) + finalizeFailed + refund user (bahkan saat pause)",
      "contributions": [
        {
          "buyer": "BUYER1_PRIVATE_KEY",
          "amountBNB": "1.0",
          "referrer": "0x0000000000000000000000000000000000000000"
        },
        { "buyer": "BUYER2_PRIVATE_KEY", "amountBNB": "1.0", "referrer": "BUYER1" }
      ],
      "expected": {
        "totalRaisedBNB": "2.0",
        "finalize": "FAILED",
        "refund": {
          "buyer1": "1.0",
          "buyer2": "1.0"
        }
      }
    }
  ],
  "tests_to_run": [
    {
      "id": "T1_MAX_WALLET_ENFORCEMENT",
      "priority": "P0",
      "steps": [
        "Pada presale scenario S1, coba BUYER1 contribute lagi 0.1 BNB (total > 1.0) harus revert (maxContribution exceeded)."
      ]
    },
    {
      "id": "T2_STATUS_SYNC_NO_DEADLOCK",
      "priority": "P0",
      "steps": [
        "Finalize dipanggil setelah endTime tanpa transaksi tambahan. Pastikan finalize tetap bisa (status sync logic bekerja)."
      ]
    },
    {
      "id": "T3_FEE_SPLIT_ASSERT_NATIVE",
      "priority": "P0",
      "steps": [
        "Sebelum finalizeSuccess, snapshot balance vaults treasury/referral/sbt.",
        "Setelah finalizeSuccess, pastikan perubahan balance sesuai fee split (share-of-fee).",
        "Rounding remainder (jika ada) masuk treasury."
      ]
    },
    {
      "id": "T4_REFUND_UNPAUSABLE",
      "priority": "P0",
      "steps": [
        "Pada scenario S3: setelah finalizeFailed, admin pause kontribusi (jika ada pause).",
        "BUYER1 dan BUYER2 harus tetap bisa claimRefund() dan menerima 100%."
      ]
    }
  ],
  "implementation_instructions": {
    "files_to_create": [
      "scripts/scenarios/00_load_deployment.ts",
      "scripts/scenarios/01_create_presale.ts",
      "scripts/scenarios/02_contribute_native.ts",
      "scripts/scenarios/03_finalize.ts",
      "scripts/scenarios/04_verify_fee_split_native.ts",
      "scripts/scenarios/05_refund.ts",
      "scripts/scenarios/run_all.ts"
    ],
    "script_behavior": [
      "Semua script membaca .env (ADMIN_PRIVATE_KEY, TIMELOCK_PRIVATE_KEY, BUYERx_PRIVATE_KEY).",
      "Gunakan provider BSC testnet dari BSC_TESTNET_RPC_URL.",
      "Jangan pernah log private key.",
      "StartTime dibuat dekat (now + 120 detik) dan EndTime pendek (start + 900 detik) agar testnet cepat. Karena testnet tidak bisa evm_increaseTime, script harus menunggu real-time atau meminta user menjalankan finalize setelah endTime lewat.",
      "Jika perlu token project untuk vesting, gunakan projectOwner dari params dan pastikan vault funding step dipenuhi sesuai invariant (fund sebelum setMerkleRoot). Untuk testing fee/refund saja, vesting root bisa di-skip."
    ],
    "create_presale_defaults": {
      "softCapWei": "parseEther('2.5')",
      "hardCapWei": "parseEther('5')",
      "maxContributionWei": "parseEther('1')",
      "minContributionWei": "parseEther('0.1')",
      "paymentToken": "address(0)",
      "dexIdEncoding": "ethers.id('PANCAKESWAP')",
      "complianceHash": "ethers.id('TESTNET_SCENARIO_<ID>')"
    },
    "events_to_parse": [
      "PresaleCreated(presaleId, round, vesting, scheduleSalt, complianceHash)",
      "Contributed(contributor, amount, referrer)",
      "FinalizedSuccess(totalRaised, feeAmount, tgeTimestamp)",
      "FinalizedFailed(reason)",
      "Refunded(contributor, amount)"
    ],
    "outputs": [
      "Cetak ringkasan per scenario: presaleId, round, vesting, scheduleSalt, totalRaised, status akhir, feeAmount, delta balance vaults, refund tx hashes."
    ]
  },
  "definition_of_done": [
    "Tiga presale berhasil dibuat di BSC testnet via factory dengan parameter softcap 2.5 BNB, hardcap 5 BNB, max/wallet 1 BNB.",
    "S1: hardcap 5 BNB tercapai, finalizeSuccess sukses, fee split terverifikasi ke 3 vault.",
    "S2: total 3 BNB (>= softcap), finalizeSuccess sukses, fee split terverifikasi.",
    "S3: total 2 BNB (< softcap), finalizeFailed sukses, refund 100% untuk buyer tetap bisa walau paused.",
    "Test max/wallet enforcement terbukti revert saat buyer melebihi 1 BNB."
  ]
}
