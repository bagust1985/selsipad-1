{
  "tag": "update",
  "task": {
    "title": "Phase 7 Monitoring (Optional) - Presale Indexer + Health + Alerts",
    "goal": "Tambahkan monitoring layer untuk presale lifecycle di BSC Testnet: indexer event -> Supabase, health endpoint, dan alert rules (SLA-based). Tidak mengubah flow Phase 1-6 yang sudah selesai.",
    "scope": {
      "do": [
        "Indexer service skeleton (event-driven) untuk PresaleFactory, PresaleRound, FeeSplitter, MerkleVesting",
        "DB tables untuk event snapshot & monitoring state",
        "Health endpoint /api/health/indexer (block lag + last indexed block)",
        "Basic alert config (Discord/Telegram webhook) untuk SLA violations"
      ],
      "do_not": [
        "Jangan lakukan live event scanning di API request path untuk finalize/claim",
        "Jangan pindahkan merkle generation ke client",
        "Jangan ubah ABI / contract address registry yang sudah dipakai FE"
      ]
    },
    "inputs": {
      "network": {
        "name": "bsc_testnet",
        "chainId": 97,
        "explorer": "https://testnet.bscscan.com",
        "rpc_env": "BSC_TESTNET_RPC_URL"
      },
      "contracts": {
        "factory": "0x237cc0f76e64DA3172bb7705287617f03DC0B016",
        "feeSplitter": "0xce329E6d7415999160bB6f47133b552a91C915a0"
      },
      "env": {
        "supabase_url_env": "SUPABASE_URL",
        "supabase_service_role_key_env": "SUPABASE_SERVICE_ROLE_KEY",
        "discord_webhook_env": "DISCORD_WEBHOOK_URL",
        "telegram_bot_token_env": "TELEGRAM_BOT_TOKEN",
        "telegram_chat_id_env": "TELEGRAM_CHAT_ID",
        "enable_alerts_env": "ENABLE_ALERTS"
      }
    },
    "deliverables": [
      {
        "type": "files_create",
        "items": [
          "services/indexer/presale-indexer.ts",
          "services/indexer/config.ts",
          "services/indexer/abi.ts",
          "services/indexer/store.ts",
          "app/api/health/indexer/route.ts",
          "lib/server/alerts/alert.ts",
          "lib/server/alerts/discord.ts",
          "lib/server/alerts/telegram.ts",
          "lib/server/alerts/rules.ts",
          "supabase/migrations/<timestamp>_presale_indexer_tables.sql"
        ]
      }
    ],
    "db_schema": {
      "create_tables": [
        {
          "name": "presale_indexer_state",
          "purpose": "Simpan lastIndexedBlock per chain untuk resume.",
          "columns": [
            "chain_id INT PRIMARY KEY",
            "last_indexed_block BIGINT NOT NULL",
            "updated_at TIMESTAMPTZ DEFAULT NOW()"
          ]
        },
        {
          "name": "presale_events",
          "purpose": "Ledger event untuk audit + debugging (append-only).",
          "columns": [
            "id UUID PRIMARY KEY DEFAULT uuid_generate_v4()",
            "chain_id INT NOT NULL",
            "contract_address TEXT NOT NULL",
            "event_name TEXT NOT NULL",
            "tx_hash TEXT NOT NULL",
            "block_number BIGINT NOT NULL",
            "log_index INT NOT NULL",
            "payload JSONB NOT NULL",
            "created_at TIMESTAMPTZ DEFAULT NOW()",
            "UNIQUE(chain_id, tx_hash, log_index)"
          ]
        },
        {
          "name": "presale_round_state",
          "purpose": "Materialized state untuk FE list/detail (fast reads).",
          "columns": [
            "round_address TEXT PRIMARY KEY",
            "chain_id INT NOT NULL",
            "factory_address TEXT",
            "vesting_address TEXT",
            "schedule_salt TEXT",
            "compliance_hash TEXT",
            "status TEXT",
            "total_raised TEXT",
            "start_time BIGINT",
            "end_time BIGINT",
            "tge_timestamp BIGINT",
            "finalized_at TIMESTAMPTZ",
            "updated_at TIMESTAMPTZ DEFAULT NOW()"
          ]
        }
      ]
    },
    "indexer_events": {
      "factory": ["PresaleCreated"],
      "round": ["Contributed", "FinalizedSuccess", "FinalizedFailed", "Cancelled", "Refunded"],
      "vesting": ["MerkleRootSet", "Claimed"],
      "feeSplitter": ["FeeSplit"]
    },
    "health_endpoint": {
      "path": "/api/health/indexer",
      "returns": {
        "chainId": 97,
        "latestBlock": "number",
        "lastIndexedBlock": "number",
        "lagBlocks": "number",
        "status": "OK|DEGRADED|DOWN"
      },
      "rules": [
        "OK jika lagBlocks <= 20",
        "DEGRADED jika 20 < lagBlocks <= 100",
        "DOWN jika lagBlocks > 100 atau indexer tidak update > 10 menit"
      ]
    },
    "alerts": {
      "enabled_by_env": "ENABLE_ALERTS=true",
      "channels": ["DISCORD_WEBHOOK_URL", "TELEGRAM_BOT_TOKEN+TELEGRAM_CHAT_ID"],
      "sla_rules": [
        {
          "id": "FINALIZE_MISSING",
          "desc": "endTime lewat tapi status belum FINALIZED_* / CANCELLED",
          "threshold_minutes": 15
        },
        {
          "id": "FEE_SPLIT_MISSING",
          "desc": "FinalizedSuccess terjadi tapi tidak ada FeeSplit event",
          "threshold_blocks": 20
        },
        {
          "id": "MERKLE_ROOT_MISSING",
          "desc": "FinalizedSuccess terjadi tapi tidak ada MerkleRootSet event",
          "threshold_minutes": 30
        },
        {
          "id": "REFUND_REVERT_SPIKE",
          "desc": "FAILED/CANCELLED tapi banyak refund gagal (opsional jika log revert tracked)",
          "threshold_count": 5
        }
      ]
    },
    "acceptance_tests": [
      "Indexer bisa start, indexing dari lastIndexedBlock, dan menulis presale_events + presale_round_state.",
      "Health endpoint return OK/DEGRADED/DOWN sesuai lag.",
      "Simulasikan finalize success: event FinalizedSuccess masuk DB dan FeeSplit juga tercatat.",
      "Jika FeeSplit tidak muncul dalam threshold, alert terkirim ke Discord/Telegram (jika ENABLE_ALERTS=true)."
    ],
    "definition_of_done": [
      "Phase 7 terpasang tanpa mengubah FE flow yang sudah selesai.",
      "FE list/detail bisa membaca dari presale_round_state (optional optimization).",
      "Health endpoint live dan alert rules berjalan.",
      "Indexer dapat resume setelah restart dengan presale_indexer_state."
    ]
  }
}
