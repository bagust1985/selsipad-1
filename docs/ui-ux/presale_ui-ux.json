{
  "module": "Presale",
  "networks": ["EVM", "Solana"],
  "doc_type": "docs/i-ux",
  "version": "1.0",
  "owner": "FE User",
  "status": "breakdown_ready",
  "goals": [
    "User dapat ikut presale (buy/contribute) di EVM & Solana dengan UX yang konsisten",
    "Project owner dapat membuat & submit presale dengan gating compliance (Dev KYC + SC Scan + Vesting + LP Lock)",
    "Admin dapat review & approve sebelum deploy/live",
    "App stabil: semua status transaksi & round dibaca dari DB/Indexer, bukan dari chain langsung"
  ],
  "scope_mvp": {
    "included": [
      "Create presale wizard (project owner)",
      "Compliance gating (Dev KYC + SC Scan PASS/OVERRIDE_PASS)",
      "Mandatory vesting: investor + team",
      "LP lock plan min 12 months (mandatory)",
      "Admin review queue + approve/reject",
      "Deploy presale (EVM & Solana)",
      "User contribute (buy) + receipt + status tracking",
      "Claim/refund basic flow sesuai outcome presale",
      "Indexer sync contributions + status round + claims/refunds"
    ],
    "excluded": [
      "Advanced whitelisting tiers (kecuali sudah ada modul/fitur lain)",
      "Multi-round complex schedules beyond MVP (kecuali sudah ada di spec kontrak)",
      "Cross-chain unified balance/portfolio reconciliation beyond presale holdings",
      "Referral reward distribution otomatis (kalau reward engine belum siap)"
    ]
  },
  "actors": [
    {
      "name": "Guest",
      "permissions": ["View presale listing", "View presale details"],
      "restrictions": ["Cannot contribute", "Cannot claim/refund"]
    },
    {
      "name": "User/Investor",
      "permissions": [
        "Connect wallet",
        "Contribute",
        "View contribution history",
        "Claim tokens",
        "Request refund (if eligible)"
      ],
      "restrictions": [
        "Must pass wallet connected + correct network",
        "Must accept terms if required"
      ]
    },
    {
      "name": "Project Owner",
      "permissions": [
        "Create presale draft",
        "Configure presale",
        "Submit for review",
        "View status",
        "Deploy after approval"
      ],
      "restrictions": [
        "Dev KYC status must be CONFIRMED",
        "SC Scan must be PASS or OVERRIDE_PASS",
        "Must set investor vesting + team vesting",
        "Must set LP lock plan >= 12 months"
      ]
    },
    {
      "name": "Admin/Reviewer",
      "permissions": [
        "Review submission",
        "Approve/Reject",
        "Override scan if policy allows",
        "Monitor live presale",
        "Force pause/cancel if policy allows"
      ],
      "restrictions": ["Actions audited + require role permission"]
    }
  ],
  "key_rules": {
    "compliance_gates": {
      "dev_kyc_required": true,
      "dev_kyc_status_allowed": ["CONFIRMED"],
      "sc_scan_required": true,
      "sc_scan_status_allowed": ["PASS", "OVERRIDE_PASS"],
      "lp_lock_min_months": 12,
      "vesting_investor_required": true,
      "vesting_team_required": true
    },
    "transaction_manager": {
      "ui_reads_from_db": true,
      "tx_states": ["CREATED", "SUBMITTED", "CONFIRMED", "FAILED", "DROPPED"],
      "retry_policy": "UI provides retry for FAILED/DROPPED if action is idempotent"
    }
  },
  "user_journeys": {
    "investor": [
      {
        "id": "INV-01",
        "name": "Contribute to presale",
        "happy_path": [
          "User buka Presale Detail",
          "Klik Connect Wallet (EVM/Solana) jika belum connect",
          "System cek network/chain benar",
          "User input amount + confirm",
          "Wallet sign/approve (jika butuh approval ERC20)",
          "Tx submitted",
          "UI menampilkan status: Submitted -> Confirmed",
          "Contribution tercatat di history + presale progress update"
        ],
        "failure_modes": [
          "User reject signature/tx",
          "Insufficient balance",
          "Wrong network",
          "Presale not live / ended",
          "Amount below min / above max",
          "RPC timeout (should recover via indexer polling)"
        ]
      },
      {
        "id": "INV-02",
        "name": "Claim tokens after success",
        "happy_path": [
          "Presale status = FINALIZED_SUCCESS",
          "User buka Presale Detail -> tab Claim",
          "System tampilkan claimable amount",
          "User click Claim -> sign/tx",
          "Tx Confirmed -> UI update claimed"
        ],
        "failure_modes": [
          "Claim before finalized",
          "Claim already done",
          "User reject signature",
          "Gas insufficient"
        ]
      },
      {
        "id": "INV-03",
        "name": "Refund after failure/cancelled",
        "happy_path": [
          "Presale status = FINALIZED_FAIL or CANCELLED",
          "User buka tab Refund",
          "System tampilkan refundable amount",
          "User click Refund -> sign/tx",
          "Tx Confirmed -> UI update refunded"
        ],
        "failure_modes": [
          "Refund not enabled yet",
          "Refund already done",
          "User reject signature",
          "Network congestion"
        ]
      }
    ],
    "project_owner": [
      {
        "id": "OWN-01",
        "name": "Create and submit presale",
        "happy_path": [
          "Owner buka Create Presale Wizard",
          "Isi basic info + token sale params",
          "Set vesting investor + vesting team (mandatory)",
          "Set LP lock plan >= 12 months (mandatory)",
          "System cek Dev KYC = CONFIRMED",
          "System cek SC Scan = PASS/OVERRIDE_PASS",
          "Submit for review",
          "Admin approve -> status APPROVED_TO_DEPLOY",
          "Owner deploy -> status LIVE (after on-chain confirmed + indexer sync)"
        ],
        "failure_modes": [
          "Dev KYC not confirmed -> block submit",
          "SC Scan not pass -> block submit",
          "Missing vesting config -> block submit",
          "LP lock plan < 12 months -> block submit",
          "Deploy failed -> show error + retry"
        ]
      }
    ],
    "admin": [
      {
        "id": "ADM-01",
        "name": "Review and approve presale",
        "happy_path": [
          "Admin buka queue submissions",
          "Review compliance checklist",
          "Approve -> status APPROVED_TO_DEPLOY",
          "Audit log tercatat",
          "Monitor presale live"
        ],
        "failure_modes": [
          "Missing docs -> reject with reason",
          "Policy conflict -> reject",
          "Need override -> apply override if allowed"
        ]
      }
    ]
  },
  "information_architecture": {
    "routes": [
      "/presales",
      "/presales/:id",
      "/presales/:id/transactions",
      "/create/presale",
      "/dashboard/owner/presales",
      "/admin/presales/review"
    ],
    "navigation_entry_points": [
      "Explore -> Presales list",
      "Project detail -> Create presale (owner only)",
      "Profile -> My presales (owner)",
      "Admin dashboard -> Presale review"
    ]
  },
  "screens": [
    {
      "id": "SCR-PRE-01",
      "name": "Presales List",
      "sections": [
        "Filters: network (EVM/Solana), status, search keyword",
        "Cards: name, network badge, progress bar, time left, min/max buy",
        "CTA: View details"
      ],
      "empty_states": ["No presales found"],
      "loading_states": ["Skeleton list"],
      "error_states": ["Failed to load list + Retry"]
    },
    {
      "id": "SCR-PRE-02",
      "name": "Presale Detail",
      "tabs": ["Overview", "Contribute", "Claim", "Refund", "Transactions"],
      "overview_sections": [
        "Header: project name, token symbol, network, status pill",
        "Progress: raised/target, participants",
        "Timeline: start/end/finalize ETA",
        "Rules: min/max, vesting summary, LP lock summary"
      ],
      "contribute_sections": [
        "Wallet status: connected/disconnected + network status",
        "Amount input + quick presets",
        "Allowance step for ERC20 (EVM only, if payment token is ERC20)",
        "CTA: Contribute",
        "Disclaimer: fees/slippage (if applicable)"
      ],
      "claim_sections": ["Eligibility block", "Claimable amount", "CTA: Claim"],
      "refund_sections": ["Eligibility block", "Refundable amount", "CTA: Refund"],
      "transactions_sections": [
        "Tx list (from DB): action, hash, status, timestamp",
        "CTA: view on explorer"
      ],
      "empty_states": ["No transactions yet"],
      "error_states": ["Indexer delay notice + manual refresh"]
    },
    {
      "id": "SCR-PRE-03",
      "name": "Create Presale Wizard (Owner)",
      "steps": [
        {
          "step": 1,
          "name": "Basic Info",
          "fields": ["Presale name", "Description", "Banner/logo", "Network selection (EVM/Solana)"]
        },
        {
          "step": 2,
          "name": "Sale Params",
          "fields": [
            "Token address/mint",
            "Sale token amount",
            "Price or rate logic (per spec)",
            "Payment token (native/USDC/etc)",
            "Min buy, Max buy",
            "Start time, End time"
          ]
        },
        {
          "step": 3,
          "name": "Vesting (Mandatory)",
          "fields": [
            "Investor vesting schedule (cliff, duration, TGE percent)",
            "Team vesting schedule (cliff, duration, TGE percent)"
          ],
          "validation": ["Cannot proceed if missing investor/team vesting"]
        },
        {
          "step": 4,
          "name": "LP Lock Plan (Mandatory)",
          "fields": [
            "Lock duration months (>=12)",
            "LP lock provider/contract/program selection (if applicable)"
          ],
          "validation": ["Cannot proceed if duration < 12"]
        },
        {
          "step": 5,
          "name": "Compliance Check",
          "checks": ["Dev KYC status", "SC Scan status"],
          "blocking_rules": ["Dev KYC must be CONFIRMED", "SC Scan must be PASS or OVERRIDE_PASS"]
        },
        {
          "step": 6,
          "name": "Review & Submit",
          "fields": ["Summary", "Terms acceptance (optional)", "Submit for review CTA"]
        }
      ],
      "post_submit_states": ["SUBMITTED_FOR_REVIEW", "REJECTED (with reason)", "APPROVED_TO_DEPLOY"]
    },
    {
      "id": "SCR-PRE-04",
      "name": "Owner Presales Dashboard",
      "sections": [
        "Table: presales created, status, network, actions",
        "Actions: edit draft, view review status, deploy (only when approved)"
      ]
    },
    {
      "id": "SCR-PRE-05",
      "name": "Admin Presales Review Queue",
      "sections": [
        "Queue list + search",
        "Detail panel: compliance checklist, configs, on-chain addresses placeholders",
        "Actions: Approve / Reject with reason / Request changes"
      ],
      "audit": ["All actions produce audit log entry"]
    }
  ],
  "ui_components": [
    {
      "name": "NetworkBadge",
      "props": ["network", "chainId(optional)"],
      "states": ["EVM", "Solana"]
    },
    {
      "name": "StatusPill",
      "props": ["status"],
      "states": [
        "DRAFT",
        "SUBMITTED_FOR_REVIEW",
        "REJECTED",
        "APPROVED_TO_DEPLOY",
        "DEPLOYING",
        "LIVE",
        "PAUSED",
        "ENDED",
        "FINALIZING",
        "FINALIZED_SUCCESS",
        "FINALIZED_FAIL",
        "CANCELLED",
        "REFUNDING",
        "CLOSED"
      ]
    },
    {
      "name": "ContributionForm",
      "props": ["network", "presaleId", "paymentTokenType", "min", "max"],
      "subcomponents": ["AllowanceStep(EVM)", "WalletStatusRow", "AmountInput", "SubmitButton"]
    },
    {
      "name": "TxStatusTimeline",
      "props": ["txIdOrHash"],
      "states": ["CREATED", "SUBMITTED", "CONFIRMED", "FAILED", "DROPPED"]
    },
    {
      "name": "ComplianceGateBanner",
      "props": ["devKycStatus", "scScanStatus", "missingFields"],
      "behavior": "Blocks wizard submit/deploy with actionable guidance"
    }
  ],
  "state_machine": {
    "presale_status": {
      "states": [
        "DRAFT",
        "SUBMITTED_FOR_REVIEW",
        "REJECTED",
        "APPROVED_TO_DEPLOY",
        "DEPLOYING",
        "LIVE",
        "PAUSED",
        "ENDED",
        "FINALIZING",
        "FINALIZED_SUCCESS",
        "FINALIZED_FAIL",
        "CANCELLED",
        "REFUNDING",
        "CLOSED"
      ],
      "transitions": [
        { "from": "DRAFT", "to": "SUBMITTED_FOR_REVIEW", "trigger": "Owner submit" },
        { "from": "SUBMITTED_FOR_REVIEW", "to": "REJECTED", "trigger": "Admin reject" },
        { "from": "SUBMITTED_FOR_REVIEW", "to": "APPROVED_TO_DEPLOY", "trigger": "Admin approve" },
        { "from": "APPROVED_TO_DEPLOY", "to": "DEPLOYING", "trigger": "Owner deploy" },
        { "from": "DEPLOYING", "to": "LIVE", "trigger": "On-chain confirmed + indexer sync" },
        { "from": "LIVE", "to": "ENDED", "trigger": "End time reached" },
        { "from": "ENDED", "to": "FINALIZING", "trigger": "Finalize called" },
        {
          "from": "FINALIZING",
          "to": "FINALIZED_SUCCESS",
          "trigger": "Finalize success condition met"
        },
        { "from": "FINALIZING", "to": "FINALIZED_FAIL", "trigger": "Finalize fail condition met" },
        { "from": "FINALIZED_FAIL", "to": "REFUNDING", "trigger": "Refund enabled" },
        { "from": "REFUNDING", "to": "CLOSED", "trigger": "Refund window ended or all refunded" }
      ]
    }
  },
  "api_contract": {
    "entities": {
      "Presale": {
        "fields": [
          "id",
          "projectId",
          "network",
          "chainIdOrCluster",
          "status",
          "saleTokenAddressOrMint",
          "paymentTokenAddressOrMint",
          "startAt",
          "endAt",
          "minBuy",
          "maxBuy",
          "totalForSale",
          "raised",
          "participantCount",
          "investorVestingPlanId",
          "teamVestingPlanId",
          "lpLockPlanId",
          "devKycStatus",
          "scScanStatus",
          "contractAddressOrProgramId",
          "createdAt",
          "updatedAt"
        ]
      },
      "PresaleContribution": {
        "fields": [
          "id",
          "presaleId",
          "walletAddress",
          "amount",
          "txHashOrSig",
          "txStatus",
          "createdAt",
          "confirmedAt"
        ]
      },
      "TxRecord": {
        "fields": [
          "id",
          "action",
          "network",
          "hashOrSig",
          "status",
          "metadata",
          "createdAt",
          "updatedAt"
        ]
      }
    },
    "endpoints_suggested": [
      { "method": "GET", "path": "/api/presales", "desc": "List presales with filters" },
      { "method": "GET", "path": "/api/presales/:id", "desc": "Get presale detail" },
      { "method": "POST", "path": "/api/presales", "desc": "Create draft (owner)" },
      { "method": "PUT", "path": "/api/presales/:id", "desc": "Update draft (owner)" },
      { "method": "POST", "path": "/api/presales/:id/submit", "desc": "Submit for admin review" },
      { "method": "POST", "path": "/api/admin/presales/:id/approve", "desc": "Approve" },
      { "method": "POST", "path": "/api/admin/presales/:id/reject", "desc": "Reject with reason" },
      {
        "method": "POST",
        "path": "/api/presales/:id/deploy",
        "desc": "Trigger deploy (owner) - returns tx record"
      },
      {
        "method": "POST",
        "path": "/api/presales/:id/contribute",
        "desc": "Create tx intent for contribute (returns calldata/ix + tx record id)"
      },
      { "method": "POST", "path": "/api/presales/:id/claim", "desc": "Create tx intent for claim" },
      {
        "method": "POST",
        "path": "/api/presales/:id/refund",
        "desc": "Create tx intent for refund"
      },
      { "method": "GET", "path": "/api/tx/:id", "desc": "Get tx record status (UI polling)" }
    ]
  },
  "chain_integration": {
    "evm": {
      "core_actions": [
        "Deploy presale contract (factory)",
        "Approve ERC20 allowance (if payment token is ERC20)",
        "Contribute transaction",
        "Claim transaction",
        "Refund transaction"
      ],
      "notes": [
        "UI should not import unused wagmi connectors; keep imports minimal",
        "Prefer reading state from indexer/DB; on-chain reads only for last-resort"
      ]
    },
    "solana": {
      "core_actions": [
        "Deploy/init presale program instance",
        "Contribute instruction",
        "Claim instruction",
        "Refund instruction"
      ],
      "notes": [
        "Use transaction signatures and confirm via indexer before showing final state",
        "Handle blockhash expiry + retry"
      ]
    }
  },
  "indexer_requirements": {
    "events_to_track": [
      "PresaleCreated/Initialized",
      "ContributionMade",
      "PresaleFinalized",
      "Claimed",
      "Refunded",
      "Paused/Unpaused",
      "Cancelled"
    ],
    "data_sync": [
      "Update presale.raised and participantCount",
      "Insert contribution rows",
      "Update claim/refund status",
      "Update presale status transitions"
    ],
    "freshness_sla": {
      "target_seconds": 15,
      "ui_behavior_if_late": "Show 'Syncing...' label and allow manual refresh"
    }
  },
  "validation_matrix": [
    { "field": "devKycStatus", "rule": "Must be CONFIRMED to submit or deploy", "blocking": true },
    {
      "field": "scScanStatus",
      "rule": "Must be PASS or OVERRIDE_PASS to submit or deploy",
      "blocking": true
    },
    { "field": "investorVestingPlan", "rule": "Required", "blocking": true },
    { "field": "teamVestingPlan", "rule": "Required", "blocking": true },
    { "field": "lpLockPlan.durationMonths", "rule": ">= 12", "blocking": true },
    { "field": "minBuy/maxBuy", "rule": "minBuy <= maxBuy and both >= 0", "blocking": true },
    {
      "field": "startAt/endAt",
      "rule": "startAt < endAt; both in future at creation",
      "blocking": true
    }
  ],
  "edge_cases": [
    "User contributes right at end time (race) -> UI relies on confirmed tx + indexer state",
    "Partial finalize states (ENDED but not FINALIZED) -> show 'Finalizing' and disable claim/refund",
    "Wallet disconnect mid-flow -> preserve draft amount and show reconnect prompt",
    "Chain RPC down -> fallback to indexer polling and show degraded mode",
    "Double click contribute/claim -> button disabled + idempotent server tx intent"
  ],
  "analytics_events": [
    { "event": "presale_list_view", "props": ["network", "filters"] },
    { "event": "presale_detail_view", "props": ["presaleId", "network", "status"] },
    { "event": "wallet_connect_click", "props": ["network", "walletType"] },
    { "event": "presale_contribute_initiated", "props": ["presaleId", "amount", "network"] },
    {
      "event": "presale_contribute_success",
      "props": ["presaleId", "amount", "network", "txHashOrSig"]
    },
    { "event": "presale_claim_initiated", "props": ["presaleId", "network"] },
    { "event": "presale_refund_initiated", "props": ["presaleId", "network"] }
  ],
  "qa_checklist": {
    "smoke": ["Presale list loads", "Presale detail loads", "No crash on profile unauthenticated"],
    "compliance_gates": [
      "Submit blocked if Dev KYC not CONFIRMED",
      "Submit blocked if SC Scan not PASS/OVERRIDE_PASS",
      "Submit blocked if vesting missing",
      "Submit blocked if LP lock duration < 12 months"
    ],
    "investor_flows_evm": [
      "Connect wallet -> contribute -> confirmed",
      "ERC20 approve -> contribute",
      "Reject tx -> error shown no crash",
      "Wrong network -> prompt switch",
      "Claim success path",
      "Refund fail path (if eligible)"
    ],
    "investor_flows_solana": [
      "Connect wallet -> contribute -> confirmed",
      "Reject signature -> error shown no crash",
      "Claim success path",
      "Refund path (if eligible)"
    ],
    "admin_flows": ["Admin can approve/reject with reason", "Audit log created"]
  },
  "milestones": [
    {
      "id": "M1",
      "name": "UI/UX + Wizard + Gating",
      "outputs": ["Create wizard screens", "Gating logic", "Owner dashboard", "Admin review UI"]
    },
    {
      "id": "M2",
      "name": "Tx Intent + Contribute (EVM & Solana)",
      "outputs": ["Contribute flow", "Tx manager integration", "DB tx status rendering"]
    },
    {
      "id": "M3",
      "name": "Finalize + Claim/Refund + Indexer Sync",
      "outputs": [
        "Claim/refund screens",
        "Status machine completeness",
        "Indexer-driven UI correctness"
      ]
    },
    {
      "id": "M4",
      "name": "Hardening + QA + Docs",
      "outputs": ["Edge-case handling", "Analytics events", "QA sign-off"]
    }
  ],
  "execution_prompt": {
    "target_agent": "sonnet",
    "input_language": "id",
    "prompt": "Anda adalah senior engineer yang mengimplementasikan modul Presale (EVM & Solana) end-to-end (FE user + API tx-intent + indexer sync + admin review) sesuai breakdown ini. Fokus utama: compliance gating (Dev KYC CONFIRMED, SC Scan PASS/OVERRIDE_PASS), vesting investor+team mandatory, LP lock plan >= 12 bulan mandatory, serta UX yang stabil dengan status transaksi dibaca dari DB/Indexer (TxRecord) bukan read-chain langsung. Implementasikan: routes /presales, /presales/:id, /create/presale, owner dashboard, admin review queue. Pastikan flow contribute/claim/refund untuk EVM & Solana berjalan, dengan loading/error/empty states, wrong network prompt, anti double-submit, serta audit log admin actions. Hasil akhir harus berupa patch PR-ready: perubahan FE components, API endpoints (tx intent), indexer event mapping, dan docs update. Sertakan juga test checklist hasil (pass/fail) untuk semua flow penting.",
    "deliverables": [
      "PR-ready patch (FE + API + indexer + docs)",
      "Checklist QA pass/fail",
      "Release note singkat + cara test"
    ],
    "constraints": [
      "Jangan menambah dependency besar yang tidak perlu",
      "Jangan refactor besar; lakukan perubahan minimal namun stabil",
      "Semua gating harus memblok submit/deploy dengan alasan yang actionable",
      "UI harus aman pada kondisi RPC lambat/timeout (fallback ke indexer polling)"
    ],
    "output_format_required": [
      "Ringkasan implementasi",
      "Daftar file yang diubah",
      "Endpoint/API contract yang dibuat/diubah",
      "Mapping event indexer",
      "Langkah testing lokal + hasil QA"
    ]
  }
}
